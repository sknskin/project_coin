generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  nickname      String?
  name          String?   // 성명
  phone         String?   // 연락처
  address       String?   // 주소
  role          UserRole  @default(USER)
  isApproved    Boolean   @default(false) @map("is_approved") // 관리자 승인 여부
  approvedAt    DateTime? @map("approved_at")
  approvedBy    String?   @map("approved_by") // 승인한 관리자 ID
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  upbitCredential          UpbitCredential?
  refreshTokens            RefreshToken[]
  watchlist                Watchlist[]
  loginHistories           LoginHistory[]
  notifications            Notification[]
  conversationParticipants ConversationParticipant[]
  sentMessages             Message[]

  @@map("users")
}

model RefreshToken {
  id          String   @id @default(uuid())
  token       String   @unique
  userId      String   @map("user_id")
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model LoginHistory {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  loginAt     DateTime @default(now()) @map("login_at")
  isSuccess   Boolean  @default(true) @map("is_success")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([loginAt])
  @@map("login_histories")
}

model UpbitCredential {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  accessKeyEnc    String   @map("access_key_enc")
  secretKeyEnc    String   @map("secret_key_enc")
  isValid         Boolean  @default(true) @map("is_valid")
  lastSyncAt      DateTime? @map("last_sync_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("upbit_credentials")
}

model Watchlist {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  marketCode  String   @map("market_code")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, marketCode])
  @@index([userId])
  @@map("watchlist")
}

model Market {
  id            String   @id @default(uuid())
  marketCode    String   @unique @map("market_code")
  koreanName    String   @map("korean_name")
  englishName   String   @map("english_name")
  marketWarning String?  @map("market_warning")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("markets")
}

model PortfolioSnapshot {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  totalBalance    Decimal  @map("total_balance") @db.Decimal(20, 8)
  totalBuyPrice   Decimal  @map("total_buy_price") @db.Decimal(20, 8)
  totalEvalPrice  Decimal  @map("total_eval_price") @db.Decimal(20, 8)
  profitLoss      Decimal  @map("profit_loss") @db.Decimal(20, 8)
  profitLossRate  Decimal  @map("profit_loss_rate") @db.Decimal(10, 4)
  snapshotAt      DateTime @default(now()) @map("snapshot_at")

  holdings        HoldingSnapshot[]

  @@index([userId, snapshotAt])
  @@map("portfolio_snapshots")
}

model HoldingSnapshot {
  id                  String   @id @default(uuid())
  portfolioSnapshotId String   @map("portfolio_snapshot_id")
  marketCode          String   @map("market_code")
  currency            String
  balance             Decimal  @db.Decimal(20, 8)
  avgBuyPrice         Decimal  @map("avg_buy_price") @db.Decimal(20, 8)
  currentPrice        Decimal  @map("current_price") @db.Decimal(20, 8)
  evalAmount          Decimal  @map("eval_amount") @db.Decimal(20, 8)
  profitLoss          Decimal  @map("profit_loss") @db.Decimal(20, 8)
  profitLossRate      Decimal  @map("profit_loss_rate") @db.Decimal(10, 4)

  portfolioSnapshot   PortfolioSnapshot @relation(fields: [portfolioSnapshotId], references: [id], onDelete: Cascade)

  @@index([portfolioSnapshotId])
  @@map("holding_snapshots")
}

// ==================== 알림 시스템 ====================
enum NotificationType {
  SYSTEM
  PRICE_ALERT
  PORTFOLIO
  CHAT
  ANNOUNCEMENT
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false) @map("is_read")
  readAt    DateTime?        @map("read_at")
  createdAt DateTime         @default(now()) @map("created_at")

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

// ==================== 채팅 시스템 ====================
model Conversation {
  id           String                    @id @default(uuid())
  createdAt    DateTime                  @default(now()) @map("created_at")
  updatedAt    DateTime                  @updatedAt @map("updated_at")

  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  userId         String       @map("user_id")
  joinedAt       DateTime     @default(now()) @map("joined_at")
  lastReadAt     DateTime?    @map("last_read_at")

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@map("conversation_participants")
}

model Message {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  senderId       String       @map("sender_id")
  content        String
  createdAt      DateTime     @default(now()) @map("created_at")
  isDeleted      Boolean      @default(false) @map("is_deleted")

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@map("messages")
}
